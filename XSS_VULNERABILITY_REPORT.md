# XSS Vulnerability Report
## NextJS Contentful Portfolio Application

**Report Date:** December 2024
**Application:** NextJS Portfolio with Contentful CMS
**Framework:** Next.js 15.3.4, React 19.0.0

---

## Executive Summary

This report identifies potential Cross-Site Scripting (XSS) vulnerabilities in the NextJS Contentful portfolio application. While the application demonstrates good security practices in several areas (React's built-in XSS protection, proper use of Next.js components), several areas require attention to mitigate XSS risks.

**Overall Risk Level:** **MEDIUM**

---

## Vulnerabilities Identified

### 1. **CRITICAL: Missing Content Security Policy (CSP) Headers**
**Severity:** High
**Location:** `src/app/layout.tsx`, `next.config.ts`
**Risk:** Without CSP headers, the application lacks defense-in-depth protection against XSS attacks.

**Current State:**
- No Content Security Policy headers configured
- No security headers middleware present

**Impact:**
- Malicious scripts could execute if other vulnerabilities are exploited
- No protection against inline script injection
- No control over external resource loading

**Recommendation:**
```typescript
// Add to next.config.ts or middleware.ts
const securityHeaders = [
  {
    key: 'Content-Security-Policy',
    value: "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https://images.ctfassets.net data:; font-src 'self' data:; connect-src 'self' https://api.smtp2go.com;"
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin'
  }
]
```

---

### 2. **MEDIUM: Unsanitized URL Display in ProjectCard Component**
**Severity:** Medium
**Location:** `src/app/projects/[slug]/components/ProjectCard.tsx:139`
**Risk:** URL field from Contentful is displayed as text without HTML encoding.

**Current Code:**
```tsx
<small className="hover:underline">{url}</small>
```

**Issue:**
- If Contentful CMS is compromised or contains malicious data, a URL like `javascript:alert('XSS')` or HTML content could be rendered
- While React escapes text content by default, displaying untrusted URLs as text without validation is risky

**Recommendation:**
```tsx
// Validate and sanitize URL before display
const sanitizeUrlForDisplay = (url: string): string => {
  try {
    const parsed = new URL(url);
    // Only allow http/https protocols for display
    if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') {
      return 'Invalid URL';
    }
    return parsed.hostname + parsed.pathname; // Display only safe parts
  } catch {
    return url; // Fallback, but should be validated upstream
  }
};

// Usage:
<small className="hover:underline">{sanitizeUrlForDisplay(url)}</small>
```

---

### 3. **MEDIUM: Incomplete Error Message Sanitization**
**Severity:** Medium
**Location:** `src/app/components/contactForm.tsx:69`
**Risk:** Error messages use basic HTML tag removal, which may not catch all XSS vectors.

**Current Code:**
```tsx
<p className="text-error small">
  {error.replace(/<[^>]*>/g, "").substring(0, 200)}
</p>
```

**Issues:**
- Regex-based sanitization is fragile and can be bypassed
- Doesn't handle encoded HTML entities
- Doesn't prevent JavaScript: protocol or other XSS vectors
- Error messages could contain user-controlled content

**Recommendation:**
```tsx
// Use proper HTML encoding function (already exists in file)
<p className="text-error small">
  {escapeHtml(error).substring(0, 200)}
</p>
```

**Note:** The `escapeHtml` function already exists in the file (lines 7-16) but is not used for error display.

---

### 4. **MEDIUM: Contentful Rich Text Rendering Without Custom Sanitization**
**Severity:** Medium
**Location:**
- `src/app/projects/[slug]/page.tsx:98`
- `src/app/projects/[slug]/components/ProjectCard.tsx:144`
- `src/app/projects/[slug]/components/ProjectCarousel.tsx:142`

**Risk:** Relies entirely on `@contentful/rich-text-react-renderer` library security.

**Current Code:**
```tsx
{documentToReactComponents(description)}
{documentToReactComponents(summary)}
```

**Issues:**
- If Contentful CMS account is compromised, malicious rich text could be injected
- No additional sanitization layer beyond library defaults
- Library may allow certain HTML tags/attributes that could be exploited

**Recommendation:**
1. Configure Contentful rich text renderer with custom options to restrict allowed nodes/marks:
```tsx
import { BLOCKS, MARKS, INLINES } from '@contentful/rich-text-types';
import { Options } from '@contentful/rich-text-react-renderer';

const options: Options = {
  renderNode: {
    [BLOCKS.PARAGRAPH]: (node, children) => <p>{children}</p>,
    // Explicitly define allowed nodes only
  },
  renderMark: {
    [MARKS.BOLD]: (text) => <strong>{text}</strong>,
    // Explicitly define allowed marks only
  },
  renderText: (text) => {
    return text.split('\n').reduce((children, textSegment, index) => {
      return [...children, index > 0 && <br key={index} />, textSegment];
    }, []);
  },
};

{documentToReactComponents(description, options)}
```

2. Implement Contentful webhook validation to verify content integrity
3. Regular security audits of Contentful space access

---

### 5. **LOW: URL Validation in ProjectCarousel**
**Severity:** Low
**Location:** `src/app/projects/[slug]/components/ProjectCarousel.tsx:145-151`
**Risk:** URL validation exists but could be more robust.

**Current Code:**
```tsx
const isValidUrl = (url: string): boolean => {
  try {
    const parsed = new URL(url);
    return parsed.protocol === "http:" || parsed.protocol === "https:";
  } catch {
    return false;
  }
};

// Usage:
{activeProject.fields.url && isValidUrl(activeProject.fields.url) && (
  <Link href={activeProject.fields.url} target="_blank">
```

**Issues:**
- Validation is good but doesn't prevent `javascript:` protocol if URL parsing fails
- No validation of URL length (could be used for DoS)
- No allowlist of trusted domains

**Recommendation:**
```tsx
const isValidUrl = (url: string): boolean => {
  try {
    const parsed = new URL(url);
    // Explicitly check protocol
    if (parsed.protocol !== "http:" && parsed.protocol !== "https:") {
      return false;
    }
    // Prevent javascript: protocol even if parsing succeeds
    if (url.toLowerCase().trim().startsWith('javascript:')) {
      return false;
    }
    // Limit URL length
    if (url.length > 2048) {
      return false;
    }
    return true;
  } catch {
    return false;
  }
};
```

---

### 6. **LOW: Metadata Title/Description from Contentful**
**Severity:** Low
**Location:** `src/app/projects/[slug]/page.tsx:69-70`
**Risk:** Metadata fields use Contentful data directly.

**Current Code:**
```tsx
return {
  title: `${activeProject.fields.title} | Paul Stroot`,
  description: documentToPlainTextString(activeProject.fields.summary),
};
```

**Issues:**
- If Contentful is compromised, malicious metadata could affect SEO and social sharing
- Title could contain special characters that break HTML structure

**Recommendation:**
```tsx
import { escapeHtml } from '@/app/utils/sanitization'; // Create utility

return {
  title: `${escapeHtml(activeProject.fields.title)} | Paul Stroot`,
  description: documentToPlainTextString(activeProject.fields.summary)
    .substring(0, 160) // Limit length
    .replace(/[<>]/g, ''), // Remove any HTML chars
};
```

---

### 7. **INFORMATIONAL: Contact Form Email Body Construction**
**Severity:** Informational
**Location:** `src/app/components/contactForm.tsx:31`
**Risk:** Email body uses string concatenation, though data is escaped before sending.

**Current Code:**
```tsx
const emailBody = `Name: ${formValues.first_name} ${formValues.last_name} \nEmail: ${formValues.email} \nPhone: ${formValues.phone} \nMessage: ${formValues.message}`;
// ...
text: escapeHtml(emailBody),
```

**Status:** ✅ **GOOD** - Data is properly escaped before sending to API.

**Note:** The `escapeHtml` function is correctly applied before sending to the API endpoint.

---

## Positive Security Practices Observed

1. ✅ **React's Built-in XSS Protection:** Using React components properly, which automatically escapes text content
2. ✅ **No `dangerouslySetInnerHTML`:** No instances found in codebase
3. ✅ **No `eval()` or `document.write()`:** No dangerous JavaScript functions found
4. ✅ **Next.js Image Component:** Using Next.js Image component for safe image rendering
5. ✅ **Slug Validation:** Proper validation of URL slugs using regex (`/^[a-zA-Z0-9-_]+$/`)
6. ✅ **Form Data Escaping:** Contact form data is properly escaped before API submission
7. ✅ **TypeScript:** Type safety helps prevent some injection vulnerabilities

---

## Recommendations Summary

### Immediate Actions (High Priority)
1. **Implement Content Security Policy headers** in `next.config.ts` or middleware
2. **Fix error message sanitization** to use existing `escapeHtml` function
3. **Add URL sanitization** for displayed URLs in ProjectCard component

### Short-term Actions (Medium Priority)
4. **Configure Contentful rich text renderer** with explicit allowed nodes/marks
5. **Enhance URL validation** in ProjectCarousel component
6. **Add security headers** (X-Frame-Options, X-Content-Type-Options, etc.)

### Long-term Actions (Low Priority)
7. **Implement Contentful webhook validation** for content integrity
8. **Add metadata sanitization** for SEO/social sharing
9. **Regular security audits** of Contentful space access and permissions
10. **Consider implementing DOMPurify** for additional client-side sanitization if needed

---

## Testing Recommendations

1. **Manual Testing:**
   - Test with malicious Contentful entries containing script tags
   - Test URL fields with `javascript:` protocol
   - Test error messages with various XSS payloads
   - Test form submissions with XSS payloads

2. **Automated Testing:**
   - Use OWASP ZAP or Burp Suite for XSS scanning
   - Implement unit tests for sanitization functions
   - Add integration tests for Contentful data rendering

3. **Contentful Security:**
   - Review Contentful space permissions
   - Enable Contentful webhook signatures
   - Implement content validation rules in Contentful

---

## References

- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [Next.js Security Headers](https://nextjs.org/docs/app/api-reference/next-config-js/headers)
- [Contentful Rich Text Renderer Documentation](https://github.com/contentful/rich-text/tree/master/packages/rich-text-react-renderer)
- [React XSS Protection](https://react.dev/learn/escape-hatches#dangerously-setting-the-inner-html)

---

## Conclusion

The application demonstrates good security practices overall, with React's built-in XSS protection and proper use of Next.js components. However, the lack of Content Security Policy headers and some areas where user-controlled or CMS-controlled data is rendered without additional sanitization layers present moderate XSS risks.

The vulnerabilities identified are primarily defensive measures that would protect against:
- Compromised Contentful CMS accounts
- Malicious content injection
- Third-party script injection
- Social engineering attacks through metadata

Implementing the recommended fixes, especially CSP headers and proper sanitization, would significantly improve the application's security posture.
